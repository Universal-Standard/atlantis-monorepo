name: Master Orchestrator

on:
  schedule:
    # Run hourly
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      force_scan:
        description: 'Force full system scan'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write
  security-events: write

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: System Status Check
        id: status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ğŸ¤– ATLANTIS Master Orchestrator Starting...\n');
            
            const status = {
              open_issues: 0,
              open_prs: 0,
              pending_reviews: 0,
              ready_to_merge: 0
            };
            
            // Count open issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            status.open_issues = issues.data.filter(i => !i.pull_request).length;
            
            // Count open PRs
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            status.open_prs = prs.data.length;
            
            // Count PRs ready to merge
            status.ready_to_merge = prs.data.filter(pr => 
              pr.labels.some(l => l.name === 'ready-to-merge')
            ).length;
            
            // Count PRs pending review
            status.pending_reviews = prs.data.filter(pr => 
              pr.labels.some(l => l.name === 'needs-review')
            ).length;
            
            console.log('Current System Status:');
            console.log(`  ğŸ“ Open Issues: ${status.open_issues}`);
            console.log(`  ğŸ”„ Open PRs: ${status.open_prs}`);
            console.log(`  â³ Pending Review: ${status.pending_reviews}`);
            console.log(`  âœ… Ready to Merge: ${status.ready_to_merge}`);
            
            core.setOutput('status', JSON.stringify(status));
            core.setOutput('needs_action', (status.open_prs > 0 || status.open_issues > 0).toString());
            
            return status;

      - name: Trigger Issue Detection
        if: github.event.inputs.force_scan == 'true' || github.event_name == 'schedule'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ğŸ” Triggering issue detection scan...');
            
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'auto-issue-detector.yml',
                ref: 'main'
              });
              console.log('âœ… Issue detection triggered');
            } catch (error) {
              console.log('âš ï¸ Could not trigger issue detection:', error.message);
            }

      - name: Process Pending Items
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = JSON.parse('${{ steps.status.outputs.status }}');
            
            if (status.open_issues === 0 && status.open_prs === 0) {
              console.log('âœ… No pending items - system idle');
              return;
            }
            
            console.log('ğŸ”§ Processing pending items...');
            
            // Get open issues that need resolution
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-detected'
            });
            
            for (const issue of issues.data) {
              if (issue.pull_request) continue; // Skip PRs
              
              // Check if issue is already being processed
              const hasInProgress = issue.labels.some(l => l.name === 'in-progress');
              if (hasInProgress) {
                console.log(`  Issue #${issue.number} already in progress`);
                continue;
              }
              
              console.log(`  ğŸ“‹ Processing issue #${issue.number}`);
              
              // Trigger resolution
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'auto-issue-resolver.yml',
                  ref: 'main',
                  inputs: {
                    issue_number: issue.number.toString()
                  }
                });
                console.log(`  âœ… Resolution triggered for issue #${issue.number}`);
              } catch (error) {
                console.log(`  âš ï¸ Failed to trigger resolution:`, error.message);
              }
            }
            
            // Get PRs that need review
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            for (const pr of prs.data) {
              const hasAutomatedFix = pr.labels.some(l => l.name === 'automated-fix');
              const hasApproved = pr.labels.some(l => l.name === 'approved');
              
              if (hasAutomatedFix && !hasApproved) {
                console.log(`  ğŸ” Triggering review for PR #${pr.number}`);
                
                try {
                  await github.rest.actions.createWorkflowDispatch({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    workflow_id: 'auto-review-and-merge.yml',
                    ref: 'main',
                    inputs: {
                      pr_number: pr.number.toString()
                    }
                  });
                  console.log(`  âœ… Review triggered for PR #${pr.number}`);
                } catch (error) {
                  console.log(`  âš ï¸ Failed to trigger review:`, error.message);
                }
              }
            }

      - name: Orchestration Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = JSON.parse('${{ steps.status.outputs.status }}');
            
            console.log('\n' + 'â•'.repeat(60));
            console.log('ğŸ¤– ATLANTIS Orchestration Complete');
            console.log('â•'.repeat(60));
            console.log('\nSystem Status:');
            console.log(`  ğŸ“ Open Issues: ${status.open_issues}`);
            console.log(`  ğŸ”„ Open PRs: ${status.open_prs}`);
            console.log(`  â³ Pending Review: ${status.pending_reviews}`);
            console.log(`  âœ… Ready to Merge: ${status.ready_to_merge}`);
            console.log('\n' + 'â•'.repeat(60));
            console.log('Next orchestration run in 1 hour');
            console.log('â•'.repeat(60) + '\n');
