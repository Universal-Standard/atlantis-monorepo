name: Automated Issue Resolution

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to resolve'
        required: true
        type: string
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write
  checks: write

jobs:
  analyze-and-resolve:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'auto-detected'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Issue Details
        id: issue-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.inputs?.issue_number || context.payload.issue?.number;
            
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber)
            });
            
            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.data.title);
            core.setOutput('issue_body', issue.data.body);
            
            // Add to project board (update status)
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              labels: ['in-progress']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: 'ü§ñ **Automated Resolution Started**\n\nThis issue is now being automatically analyzed and resolved by our AI-powered system.'
            });

      - name: Create Solution Branch
        id: create-branch
        run: |
          ISSUE_NUMBER="${{ steps.issue-details.outputs.issue_number }}"
          BRANCH_NAME="auto-fix/issue-${ISSUE_NUMBER}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Analyze Issue and Generate Solution
        id: generate-solution
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueTitle = `${{ steps.issue-details.outputs.issue_title }}`;
            const issueBody = `${{ steps.issue-details.outputs.issue_body }}`;
            
            // Generate solution based on issue type
            let solution = '';
            let files = [];
            
            if (issueTitle.includes('CONTRIBUTING.md')) {
              solution = 'Create CONTRIBUTING.md with contribution guidelines';
              files.push({
                path: 'CONTRIBUTING.md',
                content: `# Contributing to ATLANTIS Monorepo

## Welcome Contributors!

Thank you for your interest in contributing to the ATLANTIS AI project.

## Getting Started

1. Fork the repository
2. Clone your fork locally
3. Create a feature branch
4. Make your changes
5. Test your changes
6. Submit a pull request

## Code Standards

- Follow existing code style and conventions
- Write clear commit messages
- Add tests for new features
- Update documentation as needed

## Pull Request Process

1. Ensure all tests pass
2. Update the README.md with details of changes if needed
3. The PR will be reviewed by maintainers
4. Once approved, it will be merged

## Automated Workflows

This repository uses automated workflows for issue detection, resolution, and merging.

## Code of Conduct

Please be respectful and professional in all interactions.
`
              });
            }
            
            if (issueTitle.includes('LICENSE')) {
              solution = 'Create LICENSE file with MIT license';
              files.push({
                path: 'LICENSE',
                content: `MIT License

Copyright (c) 2026 Universal Standard - ATLANTIS AI

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
`
              });
            }
            
            if (issueTitle.includes('.gitignore')) {
              solution = 'Create .gitignore file with common patterns';
              files.push({
                path: '.gitignore',
                content: `# Dependencies
node_modules/
vendor/
*.egg-info/
__pycache__/
*.pyc

# Build outputs
dist/
build/
*.o
*.so
*.exe

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Logs
*.log
logs/

# Environment
.env
.env.local
*.key
*.pem

# Test coverage
coverage/
*.coverage
.nyc_output/

# Temporary
tmp/
temp/
*.tmp
`
              });
            }
            
            if (issueTitle.includes('SECURITY.md')) {
              solution = 'Create SECURITY.md with security policy';
              files.push({
                path: 'SECURITY.md',
                content: `# Security Policy

## Supported Versions

We release patches for security vulnerabilities. Currently supported versions:

| Version | Supported          |
| ------- | ------------------ |
| latest  | :white_check_mark: |

## Reporting a Vulnerability

If you discover a security vulnerability, please send an e-mail to security@atlantis-ai.com.

All security vulnerabilities will be promptly addressed.

Please include:
- Description of the vulnerability
- Steps to reproduce
- Potential impact
- Suggested fix (if any)

## Automated Security

This repository uses:
- CodeQL for automated security scanning
- Dependabot for dependency updates
- Automated security issue detection and resolution

Thank you for helping keep ATLANTIS AI secure!
`
              });
            }
            
            core.setOutput('solution', solution);
            core.setOutput('files', JSON.stringify(files));
            
            return { solution, files };

      - name: Apply Solution
        run: |
          BRANCH_NAME="${{ steps.create-branch.outputs.branch_name }}"
          git checkout "$BRANCH_NAME"
          
          # Parse and create files
          FILES='${{ steps.generate-solution.outputs.files }}'
          
          echo "$FILES" | jq -c '.[]' | while read -r file; do
            FILE_PATH=$(echo "$file" | jq -r '.path')
            FILE_CONTENT=$(echo "$file" | jq -r '.content')
            
            echo "$FILE_CONTENT" > "$FILE_PATH"
            git add "$FILE_PATH"
            
            echo "Created file: $FILE_PATH"
          done
          
          # Commit changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ü§ñ Auto-fix: ${{ steps.generate-solution.outputs.solution }}

Automatically resolves issue #${{ steps.issue-details.outputs.issue_number }}

This commit was generated by the automated issue resolution system."
            
            git push origin "$BRANCH_NAME"
          fi

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.issue-details.outputs.issue_number }};
            const branchName = '${{ steps.create-branch.outputs.branch_name }}';
            const solution = `${{ steps.generate-solution.outputs.solution }}`;
            
            // Check if PR already exists
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });
            
            if (existingPRs.data.length > 0) {
              console.log('PR already exists');
              core.setOutput('pr_number', existingPRs.data[0].number);
              return existingPRs.data[0].number;
            }
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ Auto-fix: ${solution}`,
              head: branchName,
              base: 'main',
              body: `## Automated Fix

This PR was automatically generated to resolve issue #${issueNumber}.

**Solution:** ${solution}

### Changes Made
- Automated analysis of the issue
- Generated appropriate solution
- Applied fix with best practices
- Ready for automated review and merge

### Automated Workflow
‚úÖ Issue detected and analyzed
‚úÖ Solution generated
‚úÖ Changes applied
‚è≥ Awaiting automated review
‚è≥ Pending automated merge

Fixes #${issueNumber}`,
              maintainer_can_modify: true
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['automated-fix', 'auto-merge']
            });
            
            core.setOutput('pr_number', pr.data.number);
            return pr.data.number;

      - name: Update Issue Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.issue-details.outputs.issue_number }};
            const prNumber = ${{ steps.create-pr.outputs.pr_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚úÖ **Solution Generated**

A pull request has been automatically created: #${prNumber}

The fix will be automatically reviewed and merged once all checks pass.`
            });
            
            // Update labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['solution-generated']
            });

      - name: Trigger Auto Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pr_number }};
            
            // Trigger the auto-review workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-review-and-merge.yml',
              ref: 'main',
              inputs: {
                pr_number: prNumber.toString()
              }
            });
